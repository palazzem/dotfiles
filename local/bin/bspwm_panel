#! /bin/sh

# loading configurations
. panel_config
. panel_colors
. custom_config

PANEL_WM_NAME=bspwm_panel

# check if panel is already running
if xdo id -a "$PANEL_WM_NAME" > /dev/null ; then
    printf "%s\n" "The panel is already running." >&2
    exit 1
fi

# exit gracefully if terminated
trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

# remove old panel fifo, creat new one
[ -e "$PANEL_FIFO" ] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"

# set up bspwm to not overlap the panel
bspc config top_padding "$PANEL_HEIGHT"
bspc subscribe > "$PANEL_FIFO" &

# date and time
clock -sf 'TIME%d/%m/%y, %a %H:%M' > "$PANEL_FIFO" &

# battery
BATTERY_PRESENT=$(acpi | grep -o 'Battery 0')
if [[ ! -z "$BATTERY_PRESENT" ]]; then
    while true; do
        BATT_LEVEL=$(acpi -b | grep -o '[[:digit:]]\+%' | sed 's/%//')
        if [[ $(cat "$POWERSUPPLY/online") != 1 ]]; then
            if [[ $BATT_LEVEL -ge 80 ]]; then
                BATT_ICON=$ICON_BATTERY_FULL
            elif [[ $BATT_LEVEL -ge 60 && $BATT_LEVEL -lt 80 ]]; then
                BATT_ICON=$ICON_BATTERY_THREEQUARTERS
            elif [[ $BATT_LEVEL -ge 40 && $BATT_LEVEL -lt 60 ]]; then
                BATT_ICON=$ICON_BATTERY_HALF
            elif [[ $BATT_LEVEL -ge 20 && $BATT_LEVEL -lt 40 ]]; then
                BATT_ICON=$ICON_BATTERY_QUARTER
            elif [[ $BATT_LEVEL -ge 10 && $BATT_LEVEL -lt 20 ]]; then
                BATT_ICON=$ICON_BATTERY_EMPTY
            elif [[ $BATT_LEVEL -lt 10 ]]; then
                BATT_ICON=$ICON_BATTERY_DYING
            fi
        else
            BATT_ICON=$ICON_BATTERY_CHARGING
        fi
        #uncomment next and delete the line after that to see percentage
        #echo -e $BATT_ICON %{F$COLOR_TEXT_FG} $BATT_LEVEL%%{F-}
        echo -e "BAT$BATT_ICON"
        sleep $REFRESH_BATTERY
    done > "$PANEL_FIFO" &
else
    BATT_ICON=$ICON_AC_POWER
    echo -e "BAT$BATT_ICON" > "$PANEL_FIFO" &
fi

# alsa volume
while true; do
    ALSA_VOLUME=$(amixer get Master | grep 'Playback' | grep -o '...%' -m 1 | sed 's/\[//' | sed 's/%//' | sed 's/ //')
    ALSA_STATE=$(amixer get Master | grep 'Playback' | grep -o '\[on]' -m 1)
    if [[ $ALSA_STATE ]]; then
        if [[ $ALSA_VOLUME -ge 70 ]]; then
            VOLUME_ICON=$ICON_VOLUME_HIGH
        elif [[ $ALSA_VOLUME -gt 0 && $ALSA_VOLUME -lt 70 ]]; then
            VOLUME_ICON=$ICON_VOLUME_LOW
        else
            VOLUME_ICON=$ICON_VOLUME_MUTE
        fi
    else
        VOLUME_ICON=$ICON_VOLUME_MUTE
    fi
    echo -e "VOL%{A:urxvtc -e "alsamixer":}$VOLUME_ICON%{A}"
    if [[ $(cat "$POWERSUPPLY/online") = 1 ]]; then
        sleep $REFRESH_VOLUME_FAST
    else
        sleep $REFRESH_VOLUME_SLOW
    fi
done > "$PANEL_FIFO" &

# dump panel into panel_bar and then into lemonbar
bspwm_panel_bar < "$PANEL_FIFO" | lemonbar \
    -g x"$PANEL_HEIGHT" \
    -f "$PANEL_FONT" \
    -f "$ICON_FONT" \
    -F "$COLOR_FOREGROUND" \
    -B "$COLOR_BACKGROUND" \
    | sh &

wait
